package LootableFactory
import UnitMetadata
import Lootables
import HashList
import GroupExtensions
import TlsItemLibrary
import Deck
import SpawnUndeadUnitDirector
import SpawnCards
import GameInstance

import LootLumberCard
import LootGoldCard
import LootItemCard
import LootSurvivorCard
import LootUndeadCard
import LootablesItemLibrary

constant itemChances g_smallLootableItemChances_Start = itemChances(80.0, 15.0, 4.0, 1.0)
constant itemChances g_smallLootableItemChances_End = itemChances(60.0, 30.0, 8.0, 2.0)

constant itemChances g_mediumLootableItemChances_Start = itemChances(60.0, 30.0, 8.0, 2.0)
constant itemChances g_mediumLootableItemChances_End = itemChances(40.0, 40.0, 16.0, 4.0)

constant itemChances g_largeLootableItemChances_Start = itemChances(30.0, 50.0, 16.0, 3.0)
constant itemChances g_largeLootableItemChances_End = itemChances(20.0, 42.0, 32.0, 6.0)

HashList<int> g_smallLootables = new HashList<int>()
HashList<int> g_mediumLootables = new HashList<int>()
HashList<int> g_largeLootables = new HashList<int>()

Deck g_smallLootableDeck
Deck g_mediumLootableDeck
Deck g_largeLootableDeck
Deck g_cageLootableDeck

group g_spawnOverrides

constant int LOOT_CARD_COST_SURVIVOR = 15

// ============================================================================
public class LootableUnitComponentGenerator implements IUnitComponentGenerator

  // --------------------------------------------------------------------------
  override function generateComponents(IUnitMetadata metadata) returns bool
    let u = metadata.getUnit()
    let id = u.getTypeId()

    if (id == UNIT_ID_LOOTABLE_CAGE)
      createCageLootable(metadata)
      return true

    if (g_smallLootables.has(id))
      createSmallLootable(metadata)
      return true

    if (g_mediumLootables.has(id))
      createMediumLootable(metadata)
      return true

    if (g_largeLootables.has(id))
      createLargeLootable(metadata)
      return true

    return false  

  // --------------------------------------------------------------------------
  private function createSmallLootable(IUnitMetadata metadata)
    
    let lootableComponent = new LootableComponent(metadata)
    ..setSearchDurationPerLoot(5.0)
    ..setMaxLootCount(1)

    lootableComponent.getDirector()
    ..setDeck(g_smallLootableDeck)
    ..setCreditMultiplier(1.0)
    ..setCreditsOnActivation(10)

    metadata.addComponent(lootableComponent)

    assignClosestSpawnOverride(lootableComponent)

  // --------------------------------------------------------------------------
  private function createMediumLootable(IUnitMetadata metadata)
  
    let lootableComponent = new LootableComponent(metadata)
    ..setSearchDurationPerLoot(7.5)
    ..setMaxLootCount(2)

    lootableComponent.getDirector()
    ..setDeck(g_mediumLootableDeck)
    ..setCreditMultiplier(1.0)
    ..setCreditsOnActivation(20)

    metadata.addComponent(lootableComponent)

    assignClosestSpawnOverride(lootableComponent)

    // let goldRewardStart = rangeInt(1, 1)
    // let goldRewardEnd = rangeInt(1, 2)
    // let goldReward = new LootableGoldReward(goldRewardStart, goldRewardEnd)

    // let lumberRewardStart = rangeInt(75, 150)
    // let lumberRewardEnd = rangeInt(150, 300)
    // let lumberReward = new LootableLumberReward(lumberRewardStart, lumberRewardEnd)

    // let itemReward = new LootableItemReward(g_mediumLootableItemChances_Start, g_mediumLootableItemChances_End)

    // let survivorReward = new LootableSurvivorReward()

    // let zombieReward = new LootableZombieReward()
    // ..setMinZombies(4)
    // ..setMaxZombies(8)
    // ..setItemChances(g_smallLootableItemChances_Start, g_mediumLootableItemChances_End)
    // ..setUnitModifier() (unit u, real t) ->
    //   u.setMaxHPandHP(lerpInt(60, 1000, t))
    //   u.setArmor(lerp(0.0, 2.0, t))
    //   u.setDamageRange(0, lerp(rangeInt(8, 12), rangeInt(60, 120), t))
    //   u.setMoveSpeed(lerp(100.0, 200.0, t))
    //   u.setDefenseType(ArmorType.Unarmored)
    //   u.awardLumberOnDeath(lerp(lumberRewardStart, lumberRewardEnd, t) / 8.0, 1.0)
    
    // lootable.getRewardsSet()
    // ..add(goldReward, 2)
    // ..add(lumberReward, 78)
    // ..add(itemReward, 12)
    // ..add(survivorReward, 3)
    // ..add(zombieReward, 5)

  // --------------------------------------------------------------------------
  private function createLargeLootable(IUnitMetadata metadata)
    
    let lootableComponent = new LootableComponent(metadata)
    ..setSearchDurationPerLoot(10.0)
    ..setMaxLootCount(3)

    lootableComponent.getDirector()
    ..setDeck(g_largeLootableDeck)
    ..setCreditMultiplier(1.0)
    ..setCreditsOnActivation(30)

    metadata.addComponent(lootableComponent)

    assignClosestSpawnOverride(lootableComponent)

    // let goldRewardStart = rangeInt(1, 1)
    // let goldRewardEnd = rangeInt(1, 3)
    // let goldReward = new LootableGoldReward(goldRewardStart, goldRewardEnd)

    // let lumberRewardStart = rangeInt(125, 250)
    // let lumberRewardEnd = rangeInt(250, 500)
    // let lumberReward = new LootableLumberReward(lumberRewardStart, lumberRewardEnd)

    // let itemReward = new LootableItemReward(g_largeLootableItemChances_Start, g_largeLootableItemChances_End)

    // let survivorReward = new LootableSurvivorReward()

    // let zombieReward = new LootableZombieReward()
    // ..setMinZombies(10)
    // ..setMaxZombies(15)
    // ..setItemChances(g_mediumLootableItemChances_Start, g_largeLootableItemChances_End)
    // ..setUnitModifier() (unit u, real t) ->
    //   u.setMaxHPandHP(lerpInt(60, 1000, t))
    //   u.setArmor(lerp(0.0, 2.0, t))
    //   u.setDamageRange(0, lerp(rangeInt(8, 12), rangeInt(60, 120), t))
    //   u.setMoveSpeed(lerp(100.0, 200.0, t))
    //   u.setDefenseType(ArmorType.Unarmored)
    //   u.awardLumberOnDeath(lerp(lumberRewardStart, lumberRewardEnd, t) / 15.0, 1.0)
    
    // lootable.getRewardsSet()
    // ..add(goldReward, 3)
    // ..add(lumberReward, 67)
    // ..add(itemReward, 14)
    // ..add(survivorReward, 6)
    // ..add(zombieReward, 10)

  // --------------------------------------------------------------------------
  private function createCageLootable(IUnitMetadata metadata)

    let lootableComponent = new LootableComponent(metadata)
    ..setSearchDurationPerLoot(10.0)
    ..setMaxLootCount(1)
    ..setDestroyOnLoot(true)
    
    lootableComponent.getDirector()
    ..setDeck(g_cageLootableDeck)
    ..setCreditMultiplier(0.0)
    ..setCreditsOnActivation(() -> LOOT_CARD_COST_SURVIVOR + g_GameInstance.getWorldDifficultyCoeff())

    metadata.addComponent(lootableComponent)

    assignClosestSpawnOverride(lootableComponent)

// ============================================================================
function assignClosestSpawnOverride(LootableComponent comp)
  let pos = comp.getOwnerUnit().getPos()

  let closestSpawnOverride = g_spawnOverrides.getClosestUnit(pos, 512.0)
  if (closestSpawnOverride != null)
    comp.setSpawnPosition(closestSpawnOverride.getPos())
    g_spawnOverrides.removeUnit(closestSpawnOverride)
    closestSpawnOverride.remove()

// ============================================================================
init
  g_smallLootables.add(
    UNIT_ID_LOOTABLE_BARREL,
    UNIT_ID_LOOTABLE_CART,
    UNIT_ID_LOOTABLE_CRATES,
    UNIT_ID_LOOTABLE_HAY,
    UNIT_ID_LOOTABLE_JUNK_1,
    UNIT_ID_LOOTABLE_JUNK_2,
    UNIT_ID_LOOTABLE_MARKET_BAUBLES,
    UNIT_ID_LOOTABLE_MARKET_MINECART,
    UNIT_ID_LOOTABLE_MARKET_STALL,
    UNIT_ID_LOOTABLE_MARKET_TABLE,
    UNIT_ID_LOOTABLE_TENT
  )

  g_mediumLootables.add(
    UNIT_ID_LOOTABLE_BARN,
    UNIT_ID_LOOTABLE_BUILDING_HORIZONTAL_BLUE,
    UNIT_ID_LOOTABLE_BUILDING_HORIZONTAL_GREEN,
    UNIT_ID_LOOTABLE_BUILDING_HORIZONTAL_RED,
    UNIT_ID_LOOTABLE_BUILDING_GRANARY,
    UNIT_ID_LOOTABLE_HOUSE_LARGE_BLUE,
    UNIT_ID_LOOTABLE_HOUSE_LARGE_RED,
    UNIT_ID_LOOTABLE_HOUSE_SMALL_GREEN,
    UNIT_ID_LOOTABLE_MARKET,
    UNIT_ID_LOOTABLE_TOWER,
    UNIT_ID_LOOTABLE_WINDMILL
  )

  g_largeLootables.add(
    UNIT_ID_LOOTABLE_BREWERY,
    UNIT_ID_LOOTABLE_BUILDING_CHAPEL,
    UNIT_ID_LOOTABLE_BUILDING_LARGE_HORIZONTAL_GREEN,
    UNIT_ID_LOOTABLE_BUILDING_LARGE_VERTICAL_PURPLE,
    UNIT_ID_LOOTABLE_CATHEDRAL,
    UNIT_ID_LOOTABLE_INN,
    UNIT_ID_LOOTABLE_MINE,
    UNIT_ID_LOOTABLE_SHIPYARD,
    UNIT_ID_LOOTABLE_TAVERN
  )

  g_spawnOverrides = CreateGroup()
  g_spawnOverrides.enumUnitsOfType(UNIT_ID_LOOTABLE_SPAWN_OVERRIDE, null)

  let zombieCard = new SpawnCard(SpawnDefinitions.zombies)                  ..acquire() ..setCost(3)  ..setWeight(3)
  let skeletonArchersCard = new SpawnCard(SpawnDefinitions.skeletonArchers) ..acquire() ..setCost(10) ..setWeight(2)

  let tier0SpawnDirectorDeck = new Deck()..acquire()
  tier0SpawnDirectorDeck.addDefaultCategory()
  ..addCard(zombieCard)

  let tier1SpawnDirectorDeck = new Deck()..acquire()
  tier1SpawnDirectorDeck.addDefaultCategory()
  ..addCard(zombieCard)
  ..addCard(skeletonArchersCard)

  let tier2SpawnDirectorDeck = new Deck()..acquire()
  tier2SpawnDirectorDeck.addDefaultCategory()
  ..addCard(zombieCard)
  ..addCard(skeletonArchersCard)

  let tier3SpawnDirectorDeck = new Deck()..acquire()
  tier3SpawnDirectorDeck.addDefaultCategory()
  ..addCard(zombieCard)
  ..addCard(skeletonArchersCard)

  g_smallLootableDeck = new Deck()..acquire()
  g_smallLootableDeck.addDefaultCategory()
  ..addCard(new LootLumberCard("lumber", 50)  ..setCost(3)  ..setWeight(9))
  ..addCard(new LootItemCard("item")          ..setCost(6)  ..setWeight(3))
  ..addCard(new LootGoldCard("gold")          ..setCost(30) ..setWeight(1))

  g_mediumLootableDeck = new Deck()..acquire()
  g_mediumLootableDeck.addDefaultCategory()
  // ..addCard(new LootLumberCard("lumber", 50)  ..setCost(3)  ..setWeight(12))
  // ..addCard(new LootItemCard("item")          ..setCost(6)  ..setWeight(6))
  // ..addCard(new LootGoldCard("gold")          ..setCost(30) ..setWeight(1))
  // ..addCard(new LootSurvivorCard("survivor")  ..setCost(30) ..setWeight(1))
  ..addCard(new LootUndeadCard("undead_med")  ..setCost(15) ..setWeight(1)
    ..setCreditsOnActivation(0, 15)
    ..setCreditsOnActivation(1, 30)
    ..setCreditsOnActivation(2, 45)
    ..setCreditsOnActivation(3, 60)
    ..setDeck(0, tier0SpawnDirectorDeck)
    ..setDeck(1, tier1SpawnDirectorDeck)
    ..setDeck(2, tier2SpawnDirectorDeck)
    ..setDeck(3, tier3SpawnDirectorDeck)
    ..setItemSet(0, g_LootableItemLibrary.commonSet)
    ..setItemSet(1, g_LootableItemLibrary.rareSet)
    ..setItemSet(2, g_LootableItemLibrary.epicSet)
    ..setItemSet(3, g_LootableItemLibrary.legendarySet))

  g_largeLootableDeck = new Deck()..acquire()
  g_largeLootableDeck.addDefaultCategory()
  // ..addCard(new LootLumberCard("lumber", 50)  ..setCost(3)  ..setWeight(12))
  // ..addCard(new LootItemCard("item")          ..setCost(6)  ..setWeight(6))
  // ..addCard(new LootGoldCard("gold")          ..setCost(30) ..setWeight(1))
  // ..addCard(new LootSurvivorCard("survivor")  ..setCost(30) ..setWeight(1))
  ..addCard(new LootUndeadCard("undead_lrg")  ..setCost(15) ..setWeight(1)
    ..setCreditsOnActivation(0, 15)
    ..setCreditsOnActivation(1, 30)
    ..setCreditsOnActivation(2, 45)
    ..setCreditsOnActivation(3, 60)
    ..setDeck(0, tier0SpawnDirectorDeck)
    ..setDeck(1, tier1SpawnDirectorDeck)
    ..setDeck(2, tier2SpawnDirectorDeck)
    ..setDeck(3, tier3SpawnDirectorDeck)
    ..setItemSet(0, g_LootableItemLibrary.commonSet)
    ..setItemSet(1, g_LootableItemLibrary.rareSet)
    ..setItemSet(2, g_LootableItemLibrary.epicSet)
    ..setItemSet(3, g_LootableItemLibrary.legendarySet))

  g_cageLootableDeck = new Deck()..acquire()
  g_cageLootableDeck.addDefaultCategory()
  ..addCard(new LootSurvivorCard("survivor")  ..setCost(50) ..setWeight(1))