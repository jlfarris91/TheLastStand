package UndeadTargetingComponentDebugger
import Frame
import UndeadTargetingComponent
import UnitMetadata
import ColorUtility
import UnitRecycler
import ProjectConstants
import DebuggerDialog
import Host
import PlayerExtensions
import LeashComponent

// ============================================================================
class UTCDebugger extends DebuggerRealtimeUpdateFrame

  private framehandle m_headerFrame
  // private framehandle m_notesFrame

  // --------------------------------------------------------------------------
  construct()
    super(createFrame("FRAME", "UTCDebugger", GAME_UI, "", 0))

    let frameHandle = getFrameHandle()

    m_headerFrame = createFrame("TEXTAREA", "header", GAME_UI, "", 0)
    ..setParent(frameHandle)
    ..setPoint(FRAMEPOINT_TOPLEFT, frameHandle, FRAMEPOINT_TOPLEFT)
    ..setPoint(FRAMEPOINT_BOTTOMRIGHT, frameHandle, FRAMEPOINT_BOTTOMRIGHT)
    // ..setPoint(FRAMEPOINT_TOPRIGHT, frameHandle, FRAMEPOINT_TOPRIGHT)
    // ..setHeight(15 * 0.01)

    // m_notesFrame = createFrame("TEXTAREA", "notes", GAME_UI, "", 0)
    // ..setParent(frameHandle)
    // ..setPoint(FRAMEPOINT_TOPLEFT, m_headerFrame, FRAMEPOINT_BOTTOMLEFT)
    // ..setPoint(FRAMEPOINT_BOTTOMRIGHT, frameHandle, FRAMEPOINT_BOTTOMRIGHT)

  // --------------------------------------------------------------------------
  override function realtimeUpdate(real _)

    // m_notesFrame.hide()

    BlzFrameSetText(m_headerFrame, "Orders : a:{0}, t:{1}, c:{2}-{3}".format(g_awaitingOrderGroup.size().toString(), g_numberOfOrdersIssued.toString(), g_numberOfTimesIssueOrdersStartCalled.toString(), g_numberOfTimesIssueOrdersEndCalled.toString()))

    let selectedUnit = g_HostPlayer.getFirstSelectedUnit()
    if (selectedUnit == null)
      BlzFrameSetText(m_headerFrame, "Select a unit")
      return

    BlzFrameAddText(m_headerFrame, "Selected unit : " + selectedUnit.getName())

    let metadata = selectedUnit.getMetadata()
    if (metadata == null)
      BlzFrameAddText(m_headerFrame, "Selected unit metadata is null".colorize(Colors.red))
      return

    let utc = metadata.getUndeadTargetingComponent()
    if (utc == null)
      BlzFrameAddText(m_headerFrame, "Selected unit UTC is null".colorize(Colors.red))
      return

    let targetPlayer = utc.getTargetPlayer()
    let targetUnit = utc.getTargetUnit()
    
    BlzFrameAddText(m_headerFrame, "UTC enabled : " + utc.getEnabled().toString())
    BlzFrameAddText(m_headerFrame, "Target player : " + ((targetPlayer != null) ? targetPlayer.getName() : "null"))
    BlzFrameAddText(m_headerFrame, "Target unit : " + ((targetUnit != null) ? targetUnit.getName() : "null"))
    BlzFrameAddText(m_headerFrame, "Target : " + (utc.getPreferOrganicTargets() ? "Organic" : "Structures"))
    BlzFrameAddText(m_headerFrame, "Awaiting Order : " + utc.getIsAwaitingOrder().toString())
    BlzFrameAddText(m_headerFrame, "Failed Order : " + utc.getOrderFailedReason())
    BlzFrameAddText(m_headerFrame, "Times Failed Order : " + utc.getNumberOfTimesFailedOrder().toString())
    BlzFrameAddText(m_headerFrame, "Attack Timer Expired : " + utc.getNumberOfTimesAttackTimerExpired().toString())
    BlzFrameAddText(m_headerFrame, "Distance Moved : " + utc.getDistanceMoved().toString())
    BlzFrameAddText(m_headerFrame, "Order : {0} ({1})".format(OrderId2String(GetUnitCurrentOrder(utc.getOwnerUnit())), GetUnitCurrentOrder(utc.getOwnerUnit()).toString()))
    BlzFrameAddText(m_headerFrame, "In DOT Group : " + utc.getIsInDOTGroup().toString())

    let recycler = selectedUnit.getRecycler()
    if (recycler != null)
      BlzFrameAddText(m_headerFrame, "Active in recycler \"{0}\" : {1}".format(UnitId2String(recycler.getUnitId()), recycler.isUnitActive(selectedUnit).toString()))

    let leash = selectedUnit.getLeashComponent()
    if (leash != null)
      BlzFrameAddText(m_headerFrame, "Leash: {0}".format((leash.getEnabled() ? "enabled" : "disabled")))

    // if (utc.getNotes().isEmpty() == false)
    //   m_notesFrame.show()
    //   BlzFrameSetText(m_notesFrame, "=== Notes: === ")
    //   for note in utc.getNotes()
    //     BlzFrameAddText(m_notesFrame, note)

// ============================================================================
init
  if (DEV_ENVIRONMENT)
    DebuggerDialog.registerFrame("UTC", () -> new UTCDebugger())