package WorkstationComponent
import UnitComponent
import Events
import RegisterEvents
import Loaded
import Orders
import SurvivorComponent
import SurvivorJobs
import TooltipBuilder
import ColorUtility
import StringBuilder

// ============================================================================
public class WorkstationComponent extends UnitComponent
  private group m_loadedUnits

  Event workerEntered
  Event workerExited

  // --------------------------------------------------------------------------
  construct (IUnitMetadata metadata)
    super(metadata)
    workerEntered = new Event()
    workerExited = new Event()
    m_loadedUnits = CreateGroup()

  // --------------------------------------------------------------------------
  ondestroy
    destroy workerEntered
    destroy workerExited
    m_loadedUnits.destr()

  // --------------------------------------------------------------------------
  function getWorkerUnits() returns group
    return m_loadedUnits

  // --------------------------------------------------------------------------
  function getWorkerUnitCount() returns int
    return m_loadedUnits.size()

  // --------------------------------------------------------------------------
  function unloadWorkers()
    if (m_loadedUnits.isEmpty())
      return
    let ownerUnit = getOwnerUnit()
    ownerUnit.issuePointOrderById(OrderIds.unload, ownerUnit.getPos())

  // --------------------------------------------------------------------------
  function getMaxOperatorLevel() returns int
    var level = 1
    for _unit in m_loadedUnits
      let operator = _unit.getSurvivorJobComponent(SurvivorJobs.operator)
      if (operator != null)
        level = max(level, operator.getLevel())
    return level

  // --------------------------------------------------------------------------
  override function onDisabled()
    super.onDisabled()
    unloadWorkers()

  // --------------------------------------------------------------------------
  protected function onUnitLoaded(unit loadedUnit)
    if (m_loadedUnits.contains(loadedUnit))
      return
    m_loadedUnits.addUnit(loadedUnit)
    onWorkerEntered()
    workerEntered.call()

  // --------------------------------------------------------------------------
  protected function onUnitUnloaded(unit loadedUnit)
    if (not m_loadedUnits.contains(loadedUnit))
      return
    m_loadedUnits.removeUnit(loadedUnit)
    onWorkerExited()
    workerExited.call()

  // --------------------------------------------------------------------------
  private function onWorkerEntered()
    if (getWorkerUnitCount() == 1)
      getOwnerUnit().addAnimationProperties("work")

  // --------------------------------------------------------------------------
  private function onWorkerExited()
    if (getWorkerUnitCount() == 0)
      getOwnerUnit().removeAnimationProperties("work")

// ============================================================================
public function IUnitMetadata.getWorkstationComponent() returns WorkstationComponent
  return this.getComponent(WorkstationComponent.typeId) castTo WorkstationComponent

// ============================================================================
public function IUnitMetadata.getOrAddWorkstationComponent() returns WorkstationComponent
  var component = this.getWorkstationComponent()
  if (component == null)
    component = this.addComponent(new WorkstationComponent(this)) castTo WorkstationComponent
  return component

// ============================================================================
/*
    [Workstation - Active]
    A unit is currently operating this Workstation.

    [Operator Bonuses]
    + 10% sight range
    + 10% bonus damage to target
*/
public class WorkstationIconTooltipBuilder extends TooltipBuilder
  private bool m_active

  // --------------------------------------------------------------------------
  override function getTooltipBasic() returns string

    let sb = new StringBuilder()

    let desc = getDescription()
    if (desc != null)
      sb.appendLine(desc)
      sb.appendLine()

    let activeStateString = m_active ? "Active".colorize(Colors.green) : "Inactive".colorize(Colors.gray)

    sb.appendLine("[Workstation - ".colorize(Colors.gold) + activeStateString + "]".colorize(Colors.gold))
    
    if (m_active)
      sb.appendLine("A unit is currently operating this Workstation.")
    else
      sb.appendLine("Load a unit into this Workstation to begin operations.")

    sb.appendLine()
    
    return sb.toStringAndDestroy()

  // --------------------------------------------------------------------------
  static function create(bool active) returns TooltipBuilder
    let builder = new WorkstationIconTooltipBuilder()
    builder.m_active = active
    return builder

// ============================================================================
function onUnitLoaded()
  let loadedUnit = GetLoadedUnit()
  let loadingUnit = GetTransportUnit()

  let metadata = loadingUnit.getMetadata()
  if (metadata == null)
    return

  let comp = metadata.getWorkstationComponent()
  if (comp != null)
    comp.onUnitLoaded(loadedUnit)

// ============================================================================
function onUnitUnloaded()
  let unloadedUnit = getUnloadedUnit()
  let holdingUnit = getTransportUnit(unloadedUnit)

  let metadata = holdingUnit.getMetadata()
  if (metadata == null)
    return

  let comp = metadata.getWorkstationComponent()
  if (comp != null)
    comp.onUnitUnloaded(unloadedUnit)

// ============================================================================
init
  registerPlayerUnitEvent(EVENT_PLAYER_UNIT_LOADED, function onUnitLoaded)
  registerUnitUnloadedEvent(function onUnitUnloaded)