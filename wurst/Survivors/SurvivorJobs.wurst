package SurvivorJobs
import TlsUnitIds
import HashMap
import HashList
import TlsJobItemIds
import Vector
import LinkedList
import ObjectIds
import ErrorHandling

public LinkedList<SurvivorJobDefinition> g_allJobDefinitions = new LinkedList<SurvivorJobDefinition>()
HashMap<int, SurvivorJobDefinition> g_unitTypeToJobMap = new HashMap<int, SurvivorJobDefinition>()
HashMap<int, SurvivorJobDefinition> g_itemTypeToJobMap = new HashMap<int, SurvivorJobDefinition>()

// ============================================================================
public class SurvivorJobDefinition
  private string m_id
  private HashMap<int, string> m_unitTypeToTitleMap
  private int m_itemType
  private Vector<int> m_unitTypes
  private HashList<int> m_equivalentUnitTypes
  private HashMap<int, int> m_upgradeMap
  private HashMap<player, bool> m_jobIsKnownToPlayer

  // --------------------------------------------------------------------------
  construct(string id, int itemType)
    m_id = id
    m_itemType = itemType
    m_unitTypeToTitleMap = new HashMap<int, string>()
    g_itemTypeToJobMap.put(itemType, this)
    m_unitTypes = new Vector<int>(8)
    m_equivalentUnitTypes = new HashList<int>()
    m_upgradeMap = new HashMap<int, int>()
    m_jobIsKnownToPlayer = new HashMap<player, bool>()
    g_allJobDefinitions.add(this)

  // --------------------------------------------------------------------------
  ondestroy
    destroy m_unitTypes
    m_unitTypes = null

    destroy m_equivalentUnitTypes
    m_equivalentUnitTypes = null

    destroy m_upgradeMap
    m_upgradeMap = null

    destroy m_jobIsKnownToPlayer
    m_jobIsKnownToPlayer = null

  // --------------------------------------------------------------------------
  function getId() returns string
    return m_id

  // --------------------------------------------------------------------------
  function getTitle(int unitType) returns string
    if (not m_unitTypeToTitleMap.has(unitType))
      error("Job definition does not have a title for unit type id " + unitType.toRawCode())
    return m_unitTypeToTitleMap.get(unitType)

  // --------------------------------------------------------------------------
  function setTitle(int unitType, string title)
    m_unitTypeToTitleMap.put(unitType, title)

  // --------------------------------------------------------------------------
  function registerUnitType(int unitType, string title)
    m_unitTypes.add(unitType)
    m_unitTypeToTitleMap.put(unitType, title)
    registerEquivalentUnitType(unitType)

  // --------------------------------------------------------------------------
  function registerEquivalentUnitType(int unitType)
    m_equivalentUnitTypes.add(unitType)
    g_unitTypeToJobMap.put(unitType, this)

  // --------------------------------------------------------------------------
  function registerUpgrade(int unitTypeCurrent, int unitTypeNext)
    m_upgradeMap.put(unitTypeCurrent, unitTypeNext)

  // --------------------------------------------------------------------------
  function getNextUpgrade(int unitTypeCurrent) returns int
    if (not m_upgradeMap.has(unitTypeCurrent))
      return -1
    return m_upgradeMap.get(unitTypeCurrent)

  // --------------------------------------------------------------------------
  function getUnitTypes() returns Vector<int>
    return m_unitTypes

  // --------------------------------------------------------------------------
  function getInitialUnitType() returns int
    return m_unitTypes.getFirst()

  // --------------------------------------------------------------------------
  function getItemType() returns int
    return m_itemType

  // --------------------------------------------------------------------------
  function hasUnitType(int unitType) returns bool
    return m_equivalentUnitTypes.has(unitType)

  // --------------------------------------------------------------------------
  function getIsJobKnownToPlayer(player p) returns bool
    return m_jobIsKnownToPlayer.get(p)
  
  // --------------------------------------------------------------------------
  function setIsJobKnownToPlayer(player p, bool value)
    m_jobIsKnownToPlayer.put(p, value)

  // --------------------------------------------------------------------------
  function getUpgradeTier(int unitType) returns int
    if (getInitialUnitType() == unitType)
      return 0
    for ut in m_unitTypes
      let tier = getUpgradeTierRecursive(ut, unitType, 1)
      if (tier != -1)
        return tier
    return -1
  
  // --------------------------------------------------------------------------
  private function getUpgradeTierRecursive(int currUnitType, int unitType, int tier) returns int
    if (not m_upgradeMap.has(currUnitType))
      return -1
    let upgradeUnitType = m_upgradeMap.get(currUnitType)
    if (upgradeUnitType == unitType)
      return tier
    return getUpgradeTierRecursive(upgradeUnitType, unitType, tier + 1)

// ============================================================================
public class SurvivorJobs
  static constant SurvivorJobDefinition none = new SurvivorJobDefinition("none", -1)
  static constant SurvivorJobDefinition engineer = new SurvivorJobDefinition("engineer", TlsJobItemIds.engineer1)
  static constant SurvivorJobDefinition acolyte = new SurvivorJobDefinition("acolyte", TlsJobItemIds.acolyte1)
  static constant SurvivorJobDefinition builder = new SurvivorJobDefinition("builder", TlsJobItemIds.builder1)
  static constant SurvivorJobDefinition militia = new SurvivorJobDefinition("militia", TlsJobItemIds.militia1)
  static constant SurvivorJobDefinition spearman = new SurvivorJobDefinition("spearman", TlsJobItemIds.spearman1)
  static constant SurvivorJobDefinition priest = new SurvivorJobDefinition("priest", TlsJobItemIds.priest1)
  static constant SurvivorJobDefinition marksman = new SurvivorJobDefinition("marksman", TlsJobItemIds.marksman1)

// ============================================================================
public function getJobDefinitionForUnitType(int unitType) returns SurvivorJobDefinition
  let jobDef = g_unitTypeToJobMap.get(unitType)
  if (jobDef == null)
    error("Could not find job definition for unit type {0} ({1})".format(unitType.toRawCode(), unitType.toString()))
  return jobDef

// ============================================================================
public function getJobDefinitionForItemType(int itemType) returns SurvivorJobDefinition
  let jobDef = g_itemTypeToJobMap.get(itemType)
  if (jobDef == null)
    error("Could not find job definition for item type {0} ({1})".format(itemType.toRawCode(), itemType.toString()))
  return jobDef

// ============================================================================
init
  // Survivor Male
  SurvivorJobs.none
  ..registerUnitType(TlsUnitIds.Survivors.survivorMale, "Survivor")

  // Builder
  SurvivorJobs.builder
  ..registerUnitType(TlsUnitIds.Survivors.builder1, "Builder")

  // Militia
  SurvivorJobs.militia
  ..registerUnitType(TlsUnitIds.Survivors.militia1, "Militia")
  ..registerUnitType(TlsUnitIds.Survivors.militia2, "Footman")
  ..registerUnitType(TlsUnitIds.Survivors.militia3, "Captain")
  ..registerUpgrade(TlsUnitIds.Survivors.militia1, TlsUnitIds.Survivors.militia2)
  ..registerUpgrade(TlsUnitIds.Survivors.militia2, TlsUnitIds.Survivors.militia3)

  // Spearman
  SurvivorJobs.spearman
  ..registerUnitType(TlsUnitIds.Survivors.spearman1, "Spearman")
  ..registerUnitType(TlsUnitIds.Survivors.spearman2, "Assassin")
  ..registerUpgrade(TlsUnitIds.Survivors.spearman1, TlsUnitIds.Survivors.spearman2)

  // Priest
  SurvivorJobs.priest
  ..registerUnitType(TlsUnitIds.Survivors.priest1, "Priest")

  // Acolyte
  SurvivorJobs.acolyte
  ..registerUnitType(TlsUnitIds.Survivors.acolyte1, "Acolyte")

  // Marksman
  SurvivorJobs.marksman
  ..registerUnitType(TlsUnitIds.Survivors.marksman1, "Marksman")

  // Engineer
  SurvivorJobs.engineer
  ..registerUnitType(TlsUnitIds.Survivors.engineer1, "Engineer")