package SurvivorComponent
import UnitComponent
import Statistic
import SurvivorJobs
import SurvivorJobComponent
import DisplayTextToPlayer
import MainItemLibrary
import RangedTargetXpReceieverComponent
import PersistActiveAbilityComponent
import SurvivorNames
import TlsUnitDefinition
import FX
import ColorUtility
import TlsJobItemIds
import StatisticsCollection
import ClosureEvents

group g_temp = CreateGroup()
trigger g_onSurvivorJobPreChange = CreateTrigger()
trigger g_onSurvivorJobPostChange = CreateTrigger()
unit g_jobChangingSurvivorPre
unit g_jobChangingSurvivorPost

// ============================================================================
public function onSurvivorJobPreChanged(code func)
  g_onSurvivorJobPreChange.addCondition(Condition(func))

// ============================================================================
public function onSurvivorJobPostChanged(code func)
  g_onSurvivorJobPostChange.addCondition(Condition(func))

// ============================================================================
public function getJobChangingSurvivor_PreJobChange() returns unit
  return g_jobChangingSurvivorPre

// ============================================================================
public function getJobChangingSurvivor_PostJobChange() returns unit
  return g_jobChangingSurvivorPost

// ============================================================================
function raiseSurvivorJobPreChangeEvent(unit _unit)
  g_jobChangingSurvivorPre = _unit
  g_onSurvivorJobPreChange.evaluate()
  g_jobChangingSurvivorPre = null

// ============================================================================
function raiseSurvivorJobPostChangeEvent(unit preUnit, unit postUnit)
  g_jobChangingSurvivorPre = preUnit
  g_jobChangingSurvivorPost = postUnit
  g_onSurvivorJobPostChange.evaluate()
  g_jobChangingSurvivorPre = null
  g_jobChangingSurvivorPost = null

// ============================================================================
public class SurvivorComponent extends UnitComponent
  private SurvivorJobDefinition m_activeJob
  private SurvivorJobDefinition m_lastActiveJob
  private SurvivorJobComponent m_activeJobComponent
  private bool m_changingJobs
  private string m_name
  private StatisticsCollection m_stats

  // --------------------------------------------------------------------------
  construct(IUnitMetadata owner)
    super(owner)
    m_stats = new StatisticsCollection()
    m_changingJobs = false
    m_name = null
    m_activeJobComponent = null
    m_activeJob = null
    m_lastActiveJob = null

  // --------------------------------------------------------------------------
  ondestroy
    destroy m_stats
    m_stats = null

  // --------------------------------------------------------------------------
  function getName() returns string
    return m_name

  // --------------------------------------------------------------------------
  function setName(string value)
    m_name = value
    updateUnitProperName()

  // --------------------------------------------------------------------------
  function getActiveJobComponent() returns SurvivorJobComponent
    return m_activeJobComponent

  // --------------------------------------------------------------------------
  function getActiveJob() returns SurvivorJobDefinition
    return m_activeJob

  // --------------------------------------------------------------------------
  function getLastActiveJob() returns SurvivorJobDefinition
    return m_lastActiveJob

  // --------------------------------------------------------------------------
  function getJobComponent(SurvivorJobDefinition job) returns SurvivorJobComponent
    return getOwner().getSurvivorJobComponent(job)

  // --------------------------------------------------------------------------
  function getStats() returns StatisticsCollection
    return m_stats

  // --------------------------------------------------------------------------
  function setStats(StatisticsCollection stats)
    m_stats = stats

  // --------------------------------------------------------------------------
  function getStatistic(string key) returns IStatistic
    return m_stats.getStatistic(key)

  // --------------------------------------------------------------------------
  function addStatistic(string key, IStatistic statistic)
    m_stats.addStatistic(key, statistic)

  // --------------------------------------------------------------------------
  function getChangingJobs() returns bool
    return m_changingJobs

  // --------------------------------------------------------------------------
  override function onEnabled()
    super.onEnabled()

    let owner = getOwner()

    owner.getOrAddPersistActiveAbilityComponent()
    owner.getOrAddRangedTargetXpRecieverComponent()

    // Survivors will always be able to become jobless
    assignJob(SurvivorJobs.none)
    
    let ownerUnit = getOwnerUnit()
    if (ownerUnit != null)
    //{
      let owningPlayer = ownerUnit.getOwner()
      
      if (getName() == null)
        setName(getRandomSurvivorNameForPlayer(owningPlayer))

      let job = getJobDefinitionForUnitType(ownerUnit.getTypeId())
      if (job == null)
        Log.error("SurvivorComponent", "onEnabled", ownerUnit.getName(), "Unknown job type!")

      activateJobDirectly(job)
      
      // Pick a random survivor name
      updateUnitProperName()
    //}

  // --------------------------------------------------------------------------
  private function activateJobDirectly(SurvivorJobDefinition job)

    if (m_activeJob == job)
      return

    assignJob(job)

    if (m_activeJobComponent != null)
      m_activeJobComponent.setEnabled(false)

    if (m_activeJob != null)
      m_lastActiveJob = m_activeJob

    m_activeJob = job
    m_activeJobComponent = getOwner().getOrAddSurvivorJobComponent(job)

    if (m_activeJobComponent != null)
      m_activeJobComponent.setEnabled(true)

  // --------------------------------------------------------------------------
  function assignJob(SurvivorJobDefinition job)
    getOwner().getOrAddSurvivorJobComponent(job)..setIsAssigned(true)

  // --------------------------------------------------------------------------
  function canActivateJob(SurvivorJobDefinition job) returns bool
    if (m_changingJobs or m_activeJob == job)
      return false
    if (job == SurvivorJobs.none)
      return true
    let jobComponent = getJobComponent(job)
    return jobComponent != null and jobComponent.getIsAssigned()

  // --------------------------------------------------------------------------
  function activateJob(SurvivorJobDefinition job) returns bool
    let ownerUnit = getOwnerUnit()
    let unitType = ownerUnit.getTypeId()

    if (job.hasUnitType(unitType))
      displayMessageToPlayer(ownerUnit.getOwner(), "{0} is already a {1}!".format(ownerUnit.getProperName().colorize(COLOR_GOLD), job.getTitle(unitType).colorize(COLOR_GOLD)))
      return false

    let jobComponent = getOwner().getOrAddSurvivorJobComponent(job)
    if (jobComponent == null)
      Log.error("SurvivorComponent", "activateJob", ownerUnit.getName(), "No SurvivorJobComponent exists for job " + job.getId())
      return false

    assignJob(job)

    preJobChange(ownerUnit)

    // The player has learned about this job now that they have assigned the job
    job.setIsJobKnownToPlayer(ownerUnit.getOwner(), true)

    let replacementUnitId = jobComponent.getUnitId()
    replaceUnit(replacementUnitId, jobComponent.getJob().getTitle(replacementUnitId))

    return true

  // --------------------------------------------------------------------------
  function upgradeActiveJob() returns bool
    let ownerUnit = getOwnerUnit()
    let currentUnitId = ownerUnit.getTypeId()
    let job = getJobDefinitionForUnitType(currentUnitId)
    
    let nextUnitId = job.getNextUpgrade(currentUnitId)
    if (nextUnitId == -1)
      return false

    let jobComponent = getJobComponent(job)
    if (jobComponent == null)
      Log.error("SurvivorComponent", "upgradeActiveJob", ownerUnit.getName(), "No SurvivorJobComponent exists for job " + job.getId())
      return false

    preJobChange(ownerUnit)

    // There is a bug with upgrading non-building units where the player is not charged for the upgrade - so do that now.
    let nextUnitDef = getUnitDefinition(nextUnitId)
    if (nextUnitDef != null)
      let p = getOwnerUnit().getOwner()
      p.subGold(nextUnitDef.getGoldCost())
      p.subLumber(nextUnitDef.getLumberCost())
    else
      Log.error("SurvivorComponent", "upgradeActiveJob", ownerUnit.getName(), "No definition registered for unit type {0}".format(nextUnitId.toString()))
      return false

    replaceUnit(nextUnitId, jobComponent.getJob().getTitle(nextUnitId))

    return true

  // --------------------------------------------------------------------------
  function tryEquipJobItem(item jobItem) returns bool
    if (not jobItem.isJobItem())
      return false

    let job = getJobDefinitionForItemType(jobItem.getTypeId())
    if (job == null)
      Log.error("SurvivorComponent", "tryEquipJobItem", getOwnerUnit().getName(), "No job definition found for item type " + jobItem.getName())
      return false

    if (job == SurvivorJobs.none)
      Log.error("SurvivorComponent", "tryEquipJobItem", getOwnerUnit().getName(), "Somehow the job definition is SurvivorJobs.none for item type " + jobItem.getName())
      return false

    let jobComponent = getOwner().getOrAddSurvivorJobComponent(job)
    if (jobComponent.getIsAssigned())
      displayMessageToPlayer(getOwnerUnit().getOwner(), "This survivor has already been assigned this job")
      return false
    
    // Remove the item from the game once it's consumed
    jobItem.remove()

    return activateJob(job)

  // --------------------------------------------------------------------------
  function unassignJob(SurvivorJobDefinition job) returns bool
    let ownerUnit = getOwnerUnit()
    let jobComponent = getOwner().getSurvivorJobComponent(job)
    if (jobComponent == null or not jobComponent.getIsAssigned())
      return false

    jobComponent.setIsAssigned(false)
    g_MainItemLibrary.createItemForUnit(ownerUnit, job.getItemType())
    
    if (canActivateJob(SurvivorJobs.none))
      if (not activateJob(SurvivorJobs.none))
        Log.error("SurvivorComponent", "tryUnequipJob", ownerUnit.getName(), "Could not activate the none job")

    return true

  // --------------------------------------------------------------------------
  private function preJobChange(unit oldUnit)

    m_changingJobs = true

    if (m_activeJobComponent != null)
      m_activeJobComponent.setEnabled(false)

    if (m_activeJob != null)
      m_lastActiveJob = m_activeJob

    m_activeJobComponent = null
    m_activeJob = null

    raiseSurvivorJobPreChangeEvent(oldUnit)

  // --------------------------------------------------------------------------
  private function postJobChange(unit oldUnit, unit newUnit)

    // We need to raise this no matter what, even if there is an error above, otherwise the job panel will get stuck
    // waiting for the job change to end
    raiseSurvivorJobPostChangeEvent(oldUnit, newUnit)

    if (newUnit == null)
      return
    
    // Log.info("SurvivorComponent", "onPostUnitChanged", newUnit.getName(), "newUnit 1 xp " + newUnit.getXp().toString())

    let newUnitId = newUnit.getTypeId()
    let job = getJobDefinitionForUnitType(newUnitId)
    
    m_activeJob = job
    m_activeJobComponent = getJobComponent(job)
    
    // Log.info("SurvivorComponent", "onPostUnitChanged", newUnit.getName(), "newUnit 2 xp " + newUnit.getXp().toString())

    if (m_activeJobComponent != null)
      m_activeJobComponent.setEnabled(true)
    
    // Log.info("SurvivorComponent", "onPostUnitChanged", newUnit.getName(), "newUnit 3 xp " + newUnit.getXp().toString())

    updateUnitProperName()
    
    m_changingJobs = false

  // --------------------------------------------------------------------------
  private function replaceUnit(int replacementUnitId, string jobName) returns unit
    let ownerUnit = getOwnerUnit()

    let replacedUnit = replaceUnitTLS(ownerUnit, replacementUnitId, bj_UNIT_STATE_METHOD_RELATIVE, true)

    FX.createJobChangeEffect(replacedUnit.getPos())
    FX.createJobChangeTag(jobName, replacedUnit.getPos(), replacedUnit.getOwner())

    return replacedUnit

  // --------------------------------------------------------------------------
  override function onUnitChanged(unit oldUnit, unit newUnit)

    if (oldUnit != null and newUnit != null)
      postJobChange(oldUnit, newUnit)

  // --------------------------------------------------------------------------
  private function updateUnitProperName()
    getOwnerUnit().setProperName(getName())

// ============================================================================
public function IUnitMetadata.getSurvivorComponent() returns SurvivorComponent
  return this.getComponent(SurvivorComponent.typeId) castTo SurvivorComponent

// ============================================================================
public function IUnitMetadata.getOrAddSurvivorComponent() returns SurvivorComponent
  var component = this.getSurvivorComponent()
  if (component == null)
    component = this.addComponent(new SurvivorComponent(this)) castTo SurvivorComponent
  return component

// ============================================================================
public function unit.getSurvivorComponent() returns SurvivorComponent
  let metadata = this.getMetadata()
  return metadata != null ? metadata.getSurvivorComponent() : null

// ============================================================================
public function unit.getOrAddSurvivorComponent() returns SurvivorComponent
  let metadata = this.getMetadata()
  return metadata != null ? metadata.getOrAddSurvivorComponent() : null

// ============================================================================
public function unit.getSurvivorJobComponent(SurvivorJobDefinition jobDef) returns SurvivorJobComponent
  let survivor = this.getSurvivorComponent()
  return survivor != null ? survivor.getJobComponent(jobDef) : null

// ============================================================================
function onUnitUsedItem()
  let manipulatingUnit = GetManipulatingUnit()
  let manipulatedItem = GetManipulatedItem()

  if (not manipulatedItem.isJobItem())
    return

  let comp = manipulatingUnit.getSurvivorComponent()
  if (comp == null or not comp.getEnabled())
    displayMessageToPlayer(manipulatingUnit.getOwner(), "This item can only be used by a survivor")
    return

  comp.tryEquipJobItem(manipulatedItem)

// ============================================================================
function onOrderIssued()

  let issuedOrderId = GetIssuedOrderId()
  let orderedUnit = GetOrderedUnit()

  let metadata = orderedUnit.getMetadata()
  if (metadata == null)
    return
  
  let comp = metadata.getSurvivorComponent()
  if (comp == null)
    return

  let currentUnitId = orderedUnit.getTypeId()
  let job = getJobDefinitionForUnitType(currentUnitId)
  if (job == null)
    return

  let nextUnitId = job.getNextUpgrade(currentUnitId)
  if (nextUnitId == issuedOrderId)
    comp.upgradeActiveJob()

// ============================================================================
function onUnitKilled()
  let dyingUnit = GetDyingUnit()

  if (not dyingUnit.isSurvivor())
    return

  let metadata = dyingUnit.getMetadata()
  if (metadata == null)
    return

  let survivor = metadata.getSurvivorComponent()
  if (survivor == null)
    return

  // Create an item for each enabled job
  for job in g_allJobDefinitions
  //{
    let jobComponent = survivor.getJobComponent(job)
    if (jobComponent != null and jobComponent.getIsAssigned())
      let jobItemType = job.getItemType()
      g_MainItemLibrary.createItem(jobItemType, dyingUnit.getPos())
      jobComponent.setIsAssigned(false)
  //}

// ============================================================================
function onHeroLeveledUp()
  let leveledUnit = GetLevelingUnit()
  let survivor = leveledUnit.getSurvivorComponent()
  if (survivor == null)
    return
  let activeJobComp = survivor.getActiveJobComponent()
  if (activeJobComp != null)
    activeJobComp.onLevelChanged()

// ============================================================================
function onHeroSkillPointSpent()
  let leveledUnit = GetLevelingUnit()
  let survivor = leveledUnit.getSurvivorComponent()
  if (survivor == null)
    return
  let activeJobComp = survivor.getActiveJobComponent()
  if (activeJobComp != null)
    activeJobComp.onSkillPointSpent()

// ============================================================================
init
  registerPlayerUnitEvent(EVENT_PLAYER_UNIT_USE_ITEM, function onUnitUsedItem)
  registerPlayerUnitEvent(EVENT_PLAYER_UNIT_ISSUED_ORDER, function onOrderIssued)
  registerPlayerUnitEvent(EVENT_PLAYER_UNIT_DEATH, function onUnitKilled)
  registerPlayerUnitEvent(EVENT_PLAYER_HERO_LEVEL, function onHeroLeveledUp)
  registerPlayerUnitEvent(EVENT_PLAYER_HERO_SKILL, function onHeroSkillPointSpent)